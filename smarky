#!/bin/sh
set -e

indexFile="${SMARKY_INDEX:-${XDG_DATA_HOME:-$HOME/.local/share}/smarky-index.db}"

initDatabase() {
  sqlite3 "$indexFile" "
    create table if not exists commands (
      id INTEGER PRIMARY KEY,
      command TEXT,
      description TEXT
    );"
}

usage() {
  echo "Usage information:"
  echo "  smarky create [command] [description] -- add a command to the index"
  echo "  smarky remove [index|description] ------ remove command from index"
  echo "  smarky select id ----------------------- get command by id"
  echo "  smarky list ---------------------------- list all added commands"
  echo "  smarky [help|usage|etc.] --------------- display usage information"
}

create() {
  commandLine="$1" commandDescription="$2" tmpFile="$(mktemp)"

  if [ "$#" -lt 1 ]; then
    ${EDITOR:-nano} "$tmpFile"
    commandLine="$(cat "$tmpFile")"
  fi

  sqlite3 "$indexFile" "
    insert into commands (command, description) values (
      '$(echo "$commandLine" | sed "s/'/''/g")',
      '$(echo "$commandDescription" | sed "s/'/''/g")'
    );"

  rm "$tmpFile"
}

remove() {
  echo "NOT IMPLEMENTED" >&2
}

select() {
  [ "$#" -lt 1 ] && (usage && exit 1)
  sqlite3 "$indexFile" "select command from commands where id = $1;"
}

list() {
  echo "NOT IMPLEMENTED" >&2
}

main() {
  initDatabase
  case "$1" in
    create|add) shift; create "$@" ;;
    remove|del) shift; remove "$@" ;;
    select|get) shift; select "$@" ;;
    list|show)  shift; list "$@" ;;
    *) usage
  esac
}

main "$@"
